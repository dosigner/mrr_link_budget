본 문서는 MQW(Multiple Quantum Well) 기반의 Modulating RetroReflector MRR 통신 링크 버짓을 계산하기 위한 문서이다.

구하는 방법은 2가지가 있다. 
## 안테나에서 흔히 쓰는 손실, 이득
## 광학적 손실 모델 (가우시안 빔 전파 모델, truncated 된 빔이 전파되는 모델)

uplink, downlink를 나눠서 생각할 수 있는데
## 안테나 모델의 경우
uplink에서 MRR 수신 전력
	+ Ground Station Transmitter power (parameter)
	- Ground Station Transmitter 광학계 Loss (parameter)
	- Ground Station Transmitter gain (equation: $\frac{32}{\theta_{div}^2}$, $\theta_{div}$ Full angle $e^{-2}$ divergence)
	- Uplink path Free Space Loss (equation: $(\cfrac{\lambda}{4\pi R})^2$)
	- loss due to atmospheric attenuation (abosption, scattering)
		- 가시 거리에 대한 감쇠 Kim model equation
		- (Optional) 안개 시 Mie scattering 감쇠 (Ijaz model equation)
	- Fading by Scintillation induced atmopsheric turbulence (equation, probability)
	- Loss due to tracking error (equation)
	- Loss due to UAV orientation by cat's eye optics fov and effective diameter. (equation)
	- Loss due to MRR antireflection coating (parameter)
	+ UAV Aperture Receiver gain (with Strehl Ratio) equation: $(\cfrac{\pi D_{effective}}{\lambda})^2$
	
downlink에서 수신 전력
	+ uplink에서 MRR 수신 전력 (calculated value)
	+ MRR Receiver gain (with Strehl Ratio) equation: $(\cfrac{\pi D_{effective}}{\lambda})^2 * S$ 또는 $(\cfrac{\pi D_{effective}}{\lambda})^2 * \cfrac{1}{(M^2)^2}$
	- Modulation efficiency $M=\exp(−α_{On})−exp(−α_{Off})=exp(−α_{Off})∙(C_{MQW}−1)$
	- Downlink path Free Space Loss (equation: $(\cfrac{\lambda}{4\pi R})^2$)
	- loss due to atmospheric attenuation (abosption, scattering)
		- 가시 거리에 대한 감쇠 Kim model
		- (Optional) 안개 시 Mie scattering 감쇠 (Ijaz 모델)
	- Fading by Scintillation induced atmopsheric turbulence (equation, probability)
	- Ground Station receiver gain equation: $(\cfrac{\pi D_{reciver}}{\lambda})^2$ 
	- 수신부 구조에 따라 추가 loss
		1. [bi-static, seperated 구조] transmitter하고 receiver하고 offset 수치 만큼 떨어져 있어 빔의 일부만 들어오는 loss
		2. [concentric 구조] receiver의 직경이 외경, transmitter의 직경이 내경에 의해 외경 테두리로만 들어오기 때문에 발생하는 loss
	- Receiver optics loss (fiber coupling, etc) (parameter)
	
최종 Link margin:
	+ downlink에서 수신 전력
	- Receiver sensitivity

___
## 광학적 모델의 경우
uplink에서 MRR 수신 전력  $P_{MRR_{in}}$
	+ Ground Station Transmitter power (parameter)
	- Ground Station Transmitter 광학계 Loss (parameter)
	- loss due to atmospheric attenuation (abosption, scattering)
		- 가시거리에 대한 감쇠 Kim model equation
		- (Optional) 안개 시 Mie scattering 감쇠 (Ijaz model equation)
	- Fading by Spherical wave Scintillation induced atmopsheric turbulence (equation, probability)
	- 기하광학적 Loss
		- 경로에 의해 beam spreading loss(+beam waist)와 수신부-beam footprint 간 크기 차이 (가우시안 모델)
		- Loss due to tracking error (가우시안 offset)
		- Loss due to UAV orientation by cat's eye optics fov and effective diameter. (equation)

MRR node
$\Delta P_{MRR_{out}}$ = $P_{MRR_{in}}$ * $L_{MRR_{passive}}$   * M                  
- Modulation efficiency $M=\exp(−α_{On})−exp(−α_{Off})=exp(−α_{Off})∙(C_{MQW}−1)$
- $L_{MRR_{passive}}$ Loss due to MRR optics + reflectivity (AR coating)
- **$η_{MRR}​(θ)$** represents the angle-dependent validity of retroreflection due to the cat’s-eye FOV limitation and clipping effects, and is applied at the MRR node.  
	```python
	def eta_mrr(theta_deg, knee_deg=2.12, max_deg=3.2):
    """
    Angle-dependent MRR efficiency (FOV / clipping gate)

    Parameters
    ----------
    theta_deg : float
        Angle of incidence error [deg]
    knee_deg : float
        Flat-performance knee angle [deg]
    max_deg : float
        Maximum usable FOV angle [deg]

    Returns
    -------
    eta : float
        MRR efficiency in [0, 1]
    """
    a = abs(theta_deg)

    # Flat region
    if a <= knee_deg:
        return 1.0

    # Outside FOV
    if a >= max_deg:
        return 0.0

    # Smooth roll-off region (C1 continuous)
    t = (a - knee_deg) / (max_deg - knee_deg)  # 0 → 1
    smooth = 3*t**2 - 2*t**3                   # smoothstep
    return 1.0 - smooth
	```

- **Optics-induced wavefront degradation**, once retroreflection is established, is modeled separately through an effective beam quality factor **$M^2(\theta)$ in the downlink geometric spreading loss.
```python
def mrr_m2(theta_deg,
           m2_min=1.3,
           m2_max=3.4,
           knee_deg=2.12,
           max_deg=3.2):
    """
    Angle-dependent effective M^2 due to MRR optics aberration

    Parameters
    ----------
    theta_deg : float
        Angle of incidence error [deg]

    Returns
    -------
    m2_eff : float
        Effective beam quality factor M^2
    """
    a = abs(theta_deg)

    # Flat (diffraction-limited-like) region
    if a <= knee_deg:
        return m2_min

    # Saturation at FOV edge
    if a >= max_deg:
        return m2_max

    # Smooth degradation (same smoothstep for consistency)
    t = (a - knee_deg) / (max_deg - knee_deg)
    smooth = 3*t**2 - 2*t**3
    return m2_min + (m2_max - m2_min) * smooth
```


downlink에서 수신 전력
	+ $\Delta P_{MRR_{out}}$ (calculated value)
	- loss due to atmospheric attenuation (abosption, scattering)
		- 가시거리에 대한 감쇠 Kim model
		- (Optional) 안개 시 Mie scattering 감쇠 (Ijaz 모델)
	- Fading by Plane wave Scintillation induced atmopsheric turbulence (equation, probability)
	- Receiver optics loss (fiber coupling, etc) (parameter)
	- 기하광학적 loss
		- downlink 발산각: $\theta_{downlink} \approx M^2(\theta) \cdot \frac{4\lambda}{\pi D_{effective}}$ (근사치)
		- 경로에 의해 beam spreading loss(이 때 MRR 고유(optics-induced)의 $M^2$ 값 반영)와 수신부 직경과 beam footprint 간 크기 차이 (가우시안 모델) 수신부 구조에 따라 loss 다르게
		1. [bi-static, seperated 구조] transmitter하고 receiver하고 offset 수치 만큼 떨어져 있어 빔의 일부만 들어오는 loss
		2. [concentric 구조] receiver의 직경이 외경, transmitter의 직경이 내경에 의해 외경 테두리로만 들어오기 때문에 발생하는 loss
	
최종 Link margin:
	+ downlink에서 수신 전력
	- Receiver sensitivity